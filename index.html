<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<title>OpenLayers HisGIS OSM API Kadaster</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
<style>
  html, body, #map {
    margin:0; padding:0; width:100%; height:100%;
  }
  .ol-popup {
    position: absolute;
    background-color: white;
    padding: 5px 10px;
    border: 1px solid #ccc;
    bottom: 12px;
    left: -50px;
    min-width: 200px;
  }
  .ol-popup:after, .ol-popup:before {
    top: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
  }
  .ol-popup:after {
    border-top-color: white;
    border-width: 10px;
    left: 48px;
    margin-left: -10px;
  }
  .ol-popup:before {
    border-top-color: #ccc;
    border-width: 11px;
    left: 48px;
    margin-left: -11px;
  }
  .label {
    background-color: rgba(161, 0, 0, 0.7);
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-weight: bold;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="popup" class="ol-popup" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0/osmtogeojson.js"></script>

<script>
  const map = new ol.Map({
    target: 'map',
    layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
    view: new ol.View({
      center: ol.proj.fromLonLat([5.775, 52.64]),
      zoom: 14
    })
  });

  const popupContainer = document.getElementById('popup');
  const popupOverlay = new ol.Overlay({
    element: popupContainer,
    positioning: 'bottom-center',
    stopEvent: false,
    offset: [0, -10]
  });
  map.addOverlay(popupOverlay);

  function tagsTable(tags) {
    if (!tags) return '';
    let html = '<table><thead><tr><th>tag</th><th>waarde</th></tr></thead><tbody>';
    for (const [k, v] of Object.entries(tags)) {
      html += `<tr><td>${k}</td><td>${v}</td></tr>`;
    }
    html += '</tbody></table>';
    return html;
  }

  function styleFunction(feature, resolution) {
    const tags = feature.get('tags') || {};
    const fillColor = tags.building ? 'rgba(255, 68, 68, 0.4)' :
      tags['natural'] === 'water' ? 'rgba(118,169,255,0.35)' :
      'rgba(255,255,255,0.4)';
    return new ol.style.Style({
      fill: new ol.style.Fill({
        color: fillColor,
      }),
      stroke: new ol.style.Stroke({ color: '#a10000', width: 2 }),
      text: new ol.style.Text({
        text: map.getView().getZoom() >= 18 ? buildLabelText(feature) : '',
        font: 'bold 14px sans-serif',
        fill: new ol.style.Fill({ color: '#a10000' }),
        stroke: new ol.style.Stroke({ color: 'white', width: 3 }),
        overflow: true
      })
    });
  }

  function buildLabelText(feature) {
    const tags = feature.get('tags') || {};
    let label = tags['kad:perceelnr'] || "";
    if (tags['kad:perceelnrtvg']) {
      label += '/' + tags['kad:perceelnrtvg'];
    }
    return label;
  }

  function createLabelElement(text) {
    const div = document.createElement('div');
    div.className = 'label';
    div.textContent = text;
    return div;
  }

  const vectorSource = new ol.source.Vector();
  const vectorLayer = new ol.layer.Vector({
    source: vectorSource,
    style: styleFunction
  });
  map.addLayer(vectorLayer);

  // Voeg labels als overlay markers toe boven features
  let labelOverlays = [];
  function clearLabels() {
    labelOverlays.forEach(overlay => map.removeOverlay(overlay));
    labelOverlays = [];
  }
  function updateLabels() {
    clearLabels();
    if(map.getView().getZoom() < 18) return;
    vectorSource.getFeatures().forEach(feature => {
      const labelText = buildLabelText(feature);
      if(!labelText) return;
      const extent = feature.getGeometry().getExtent();
      const center = ol.extent.getCenter(extent);
      const labelOverlay = new ol.Overlay({
        element: createLabelElement(labelText),
        position: center,
        stopEvent: false,
        offset: [0, -15]
      });
      map.addOverlay(labelOverlay);
      labelOverlays.push(labelOverlay);
    });
  }

  // Klik event handler met Turf.js om hole detectie toe te passen
  map.on('singleclick', function (evt) {
    popupOverlay.setPosition(undefined);
    popupContainer.style.display = 'none';

    const coordinate = evt.coordinate;
    const features = [];
    map.forEachFeatureAtPixel(evt.pixel, function(feature) {
      features.push(feature);
    });

    if(features.length === 0) return;

    for(const feature of features) {
      const geom = feature.getGeometry();
      const geoCoords = geom.clone().transform('EPSG:3857','EPSG:4326').getCoordinates();
      let geojsonGeom;
      if(geom.getType() === 'Polygon') {
        geojsonGeom = turf.polygon(geoCoords);
      } else if(geom.getType() === 'MultiPolygon') {
        geojsonGeom = turf.multiPolygon(geoCoords);
      }

      if(geojsonGeom) {
        const clickPoint = turf.point(ol.proj.toLonLat(coordinate));
        let insideHole = false;
        for(let i = 1; i < geojsonGeom.geometry.coordinates.length; i++) {
          let holePoly = turf.polygon([geojsonGeom.geometry.coordinates[i]]);
          if(turf.booleanPointInPolygon(clickPoint, holePoly)) {
            insideHole = true;
            console.log('Klik binnen hole, geen popup');
            break;
          }
        }
        if(insideHole) continue;
      }

      const tags = feature.get('tags') || {};
      if(Object.keys(tags).length > 0){
        const content = tagsTable(tags);
        popupContainer.innerHTML = content;
        popupOverlay.setPosition(coordinate);
        popupContainer.style.display = 'block';
        console.log('Popup getoond met tags', tags);
        return; // laat slechts 1 popup zien
      }
    }
  });

  // Data laden van OSM API
  function loadData(){
    const bbox = '5.76,52.61,5.79,52.67'; // from query example
    const url = `https://osm.hisgis.nl/api/0.6/map?bbox=${bbox}`;
    fetch(url, { headers: {'Accept':'application/json'}})
    .then(resp => resp.json())
    .then(osmJson => {
      // Zet osmJson om naar GeoJSON via osmtogeojson
      const geojson = osmtogeojson(osmJson);
      // Transformeer features naar map projectie EPSG:3857
      const format = new ol.format.GeoJSON();
      const features = format.readFeatures(geojson, {
        featureProjection: 'EPSG:3857',
        dataProjection: 'EPSG:4326'
      });
      vectorSource.clear();
      vectorSource.addFeatures(features);
      updateLabels();
    })
    .catch(e => {
      console.error('Fout bij laden data:', e);
    });
  }

  loadData();

  // Update labels bij zoomwijziging
  map.getView().on('change:resolution', updateLabels);
</script>
</body>
</html>
