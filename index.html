<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<title>OpenLayers Kadaster met uitgebreide OAT weergave</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-layerswitcher/dist/ol-layerswitcher.css" />
<style>
  html, body {
    margin:0; padding:0; height: 100%; overflow: hidden;
    font-family: Arial, sans-serif;
  }
  #container {
    display: flex; height: 100%;
    width: 100vw;
  }
  #map {
    flex-grow: 1;
  }
  #info {
    width: 370px;
    background: #fff;
    border-left: 1px solid #ccc;
    overflow-y: auto;
    padding: 10px;
  }
  h2 {
    margin-top: 0;
  }
  table {
    border-collapse: collapse; width: 100%; margin-bottom: 15px;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 4px 6px; text-align: left;
  }
  ul {
    margin-top: 2px;
    padding-left: 18px;
  }
  .label {
    background-color: rgba(161, 0, 0, 0.7);
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-weight: bold;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body>
<div id="container">
  <div id="map"></div>
  <div id="info"><h2>Perceelinformatie</h2><div id="info-content">Klik op een perceel voor details</div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ol-layerswitcher"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="osmtogeojson.js"></script>

<script>
(() => {
  const OAT_HIDE_KEYS = new Set([
    'importContextNr','accepteer','annotaties','extraperceelnrs','geenGebouw','geschrapt',
    'nok','nr','perceelnr','perceelnrtvg','sectie','tvg','artikelLink','perceelTarieven'
  ]);
  const OSM_HIDE_KEYS = new Set([
    'timestamp','version','changeset','user','uid','id','geometry','hgis:soort'
  ]);

  function createArtikelString(artikelLink){
    if(!artikelLink) return '';
    return `Artikel Nr: ${artikelLink.artikelnr || ''}, Reeks: ${artikelLink.reeks || ''}`;
  }

  function formatFlorijn(value, alwaysTwoDecimals=true){
    const numberValue = Number(value)/100;
    if(alwaysTwoDecimals) return `&#402;&thinsp;${numberValue.toFixed(2)}`;
    const decimals = numberValue % 1;
    if(decimals === 0) return `&#402;&thinsp;${Math.floor(numberValue)}`;
    else return `&#402;&thinsp;${numberValue.toFixed(2)}`;
  }

  function formatOppervlak(value){
    return `${value}\u2009m\u00B2`;
  }

  const osmLayer = new ol.layer.Tile({
    source: new ol.source.OSM(),
    visible: false,
    title: 'OpenStreetMap',
    type: 'base'
  });
  const luchtfotoLayer = new ol.layer.Tile({
    source: new ol.source.TileWMS({
      url: 'https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0?',
      params: {LAYERS:'Actueel_ortho25', FORMAT:'image/jpeg'},
      serverType: 'geoserver'
    }),
    visible: true,
    title: 'PDOK Luchtfoto',
    type: 'base'
  });
  const minuutplanLayer = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url:'https://tileserver.huc.knaw.nl/{z}/{x}/{y}'
    }),
    visible: false,
    title: 'Minuutplan 1832',
    type: 'base'
  });

  const vectorSource = new ol.source.Vector();
  const vectorLayer = new ol.layer.Vector({
    source: vectorSource,
    title: 'Percelen',
    properties: {'title': 'Percelen', 'type': 'overlay'},
    style: feature => {
      const props = feature.getProperties();
      if(props.building) {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(255,68,68,0.4)'}),
          stroke: new ol.style.Stroke({color: '#a10000', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.landuse === 'construction') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(70,70,70,0.6)'}),
          stroke: new ol.style.Stroke({color: '#464646', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.natural === 'water') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(118,169,255,0.35)'}),
          stroke: new ol.style.Stroke({color: '#1380ff', width: 2})
        });
      }
      if(props.landuse === 'residential' && !props.building) {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(136,136,136,0.2)'}),
          stroke: new ol.style.Stroke({color: '#888', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.landuse === 'meadow') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(165,214,167,0.4)'}),
          stroke: new ol.style.Stroke({color: '#4caf50', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.landuse === 'forrest') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(0,51,0,0.6)'}),
          stroke: new ol.style.Stroke({color: '#004d00', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.landuse === 'allotments') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(255,247,153,0.6)'}),
          stroke: new ol.style.Stroke({color: '#e6c300', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.landuse === 'orchard') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(255,183,77,0.6)'}),
          stroke: new ol.style.Stroke({color: '#d97b00', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.landuse === 'farmland') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(62,39,35,0.6)'}),
          stroke: new ol.style.Stroke({color: '#4e342e', width: 2}),
          text: createFeatureText(feature)
        });
      }
      if(props.natural === 'sand') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(244,241,233,0.6)'}),
          stroke: new ol.style.Stroke({color: '#d9cbbd', width: 2}),
          text: createFeatureText(feature)
        });
      }
      // default zwarte rand
      return new ol.style.Style({
        fill: new ol.style.Fill({color: 'rgba(255,255,255,0.4)'}),
        stroke: new ol.style.Stroke({color: 'black', width: 2}),
        text: createFeatureText(feature)
      });
    }
  });

  const highlightStyle = feature => new ol.style.Style({
    stroke: new ol.style.Stroke({ color: 'rgba(255, 255, 0, 0.7)', width: 10 }),
    fill: new ol.style.Fill({ color: 'rgba(255, 255, 0, 0.1)' }),
    text: createFeatureText(feature)
  });

  function createFeatureText(feature) {
    if(map){
      const zoom = map.getView().getZoom();
      if(zoom < 18) return null;
    }
    const props = feature.getProperties() || {};
    let text = props['kad:perceelnr'] || '';
    if(props['kad:perceelnrtvg']) text += '/' + props['kad:perceelnrtvg'];
    return new ol.style.Text({
      text: text,
      font: 'bold 14px Calibri,sans-serif',
      fill: new ol.style.Fill({ color: '#a10000' }),
      stroke: new ol.style.Stroke({ color: 'white', width: 3 }),
      overflow: true
    });
  }

  const map = new ol.Map({
    target: 'map',
    layers: [osmLayer, luchtfotoLayer, minuutplanLayer, vectorLayer],
    view: new ol.View({
      center: ol.proj.fromLonLat([5.775, 52.64]),
      zoom: 14,
      minZoom: 2,
      maxZoom: 22
    })
  });

  const layerSwitcher = new ol.control.LayerSwitcher({
    tipLabel: 'Kaartlagen',
    collapsed: false,
    groupSelectStyle: 'children'
  });
  map.addControl(layerSwitcher);

  const infoDiv = document.getElementById('info-content');

  let highlightFeature = null;

  function buildPopupTable(oatTags = {}, osmProps = {}) {
    let html = `<h3>OSM Tags</h3><table><thead><tr><th>Tag</th><th>Waarde</th></tr></thead><tbody>`;
    for(let [k,v] of Object.entries(osmProps)){
      if(v !== undefined && v !== null && !OSM_HIDE_KEYS.has(k)){
        html += `<tr><td>${k}</td><td>${v}</td></tr>`;
      }
    }
    html += `</tbody></table><h3>OAT Perceelgegevens</h3>`;

    // oppervlak eerst
    if(oatTags.oppervlak !== undefined && oatTags.oppervlak !== null){
      html += `<p><strong>Oppervlak:</strong> ${formatOppervlak(oatTags.oppervlak)}</p>`;
    }
    // grondGebruik vlak na oppervlak
    if(oatTags.grondGebruik){
      html += `<p><strong>Grondgebruik:</strong> ${oatTags.grondGebruik}</p>`;
    }

    // overige velden
    let filteredKeys = Object.keys(oatTags).filter(k =>
      k !== 'oppervlak' && k !== 'grondGebruik' && k !== 'perceelTarieven' &&
      oatTags[k] !== null && oatTags[k] !== undefined && !OAT_HIDE_KEYS.has(k));

    if(filteredKeys.length > 0){
      html += `<table><thead><tr><th>Attribuut</th><th>Waarde</th></tr></thead><tbody>`;
      filteredKeys.forEach(k=>{
        let v = oatTags[k];
        if(k === 'artikelLink'){
          html += `<tr><td>Artikel</td><td>${createArtikelString(v)}</td></tr>`;
        } else if(k === 'oatScan'){
          try{
            const url = 'https://tvermaut.github.io/hisgis-oat-scan-view/?'+ encodeURIComponent(v.code);
            html += `<tr><td>Scan</td><td><a href="${url}" target="_blank" rel="noopener noreferrer">Bekijk scan</a></td></tr>`;
          }catch(e){
            html += `<tr><td>Scan</td><td>Onbekende scan</td></tr>`;
          }
        } else if(k === 'belastbaar_inkomen'){
          html += `<tr><td>bel.ink.</td><td>${formatFlorijn(v,true)}</td></tr>`;
        } else if(k === 'belastbaar_inkomen_gebouwd'){
          html += `<tr><td>bel.ink.geb.</td><td>${formatFlorijn(v,false)}</td></tr>`;
        } else{
          html += `<tr><td>${k}</td><td>${v}</td></tr>`;
        }
      });
      html += `</tbody></table>`;
    }

    // perceelTarieven show per specs: label tarief zonder bullets als 1 tarief, bullets if meerdere
    if(oatTags.perceelTarieven && oatTags.perceelTarieven.length > 0){
      const tariefCount = oatTags.perceelTarieven.length;
      if(tariefCount === 1){
        const x = oatTags.perceelTarieven[0];
        if(x.tarief && x.tarief.tariefsoort && x.tarief.klasse && x.oppervlak && x.tarief.tarief){
          const naam = x.tarief.tariefsoort.naam;
          const klasse = x.tarief.klasse;
          const op = x.oppervlak;
          const tariefValue = x.tarief.tarief/100;
          const totaal = Math.round((op/100)*tariefValue*100)/100;
          html += `<p><strong>tarief:</strong> ${naam} - ${klasse} (${op}\u2009m\u00B2 × &#402;&thinsp;${tariefValue} = &#402;&thinsp;${totaal.toFixed(2)})</p>`;
        }
      } else {
        html += `<p><strong>tarief:</strong></p><ul>`;
        oatTags.perceelTarieven.forEach(x => {
          if(x.tarief && x.tarief.tariefsoort && x.tarief.klasse && x.oppervlak && x.tarief.tarief){
            const naam = x.tarief.tariefsoort.naam;
            const klasse = x.tarief.klasse;
            const op = x.oppervlak;
            const tariefValue = x.tarief.tarief/100;
            const totaal = Math.round((op/100)*tariefValue*100)/100;
            html += `<li>${naam} - ${klasse} (${op}\u2009m\u00B2 × &#402;&thinsp;${tariefValue} = &#402;&thinsp;${totaal.toFixed(2)})</li>`;
          }
        });
        html += `</ul>`;
      }
    }


    return html;
  }

  map.on('singleclick', evt => {
    if(highlightFeature){
      highlightFeature.setStyle(undefined);
      highlightFeature = null;
    }

    const features = [];
    map.forEachFeatureAtPixel(evt.pixel, f => features.push(f));
    if(features.length === 0){
      infoDiv.innerHTML = '<p>Klik op een perceel voor informatie</p>';
      return;
    }

    let selFeature = features.find(f => {
      const p = f.getProperties();
      return p['kad:gemeente'] && p['kad:sectie'] && p['kad:perceelnr'];
    });
    if(!selFeature) selFeature = features[0];

    highlightFeature = selFeature;
    highlightFeature.setStyle(highlightStyle(selFeature));

    const props = selFeature.getProperties();
    const geom = selFeature.getGeometry();
    if(!geom){
      infoDiv.innerHTML = '<p>Geen geometrie beschikbaar</p>';
      return;
    }

    const coords = geom.clone().transform('EPSG:3857','EPSG:4326').getCoordinates();
    let turfGeom = null;
    if(geom.getType() === 'Polygon') turfGeom = turf.polygon(coords);
    else if(geom.getType() === 'MultiPolygon') turfGeom = turf.multiPolygon(coords);

    if(turfGeom){
      const point = turf.point(ol.proj.toLonLat(evt.coordinate));
      for(let i=1; i<turfGeom.geometry.coordinates.length; i++){
        const holePoly = turf.polygon([turfGeom.geometry.coordinates[i]]);
        if(turf.booleanPointInPolygon(point, holePoly)){
          infoDiv.innerHTML = '<p>Klik in hole, geen info getoond</p>';
          return;
        }
      }
    }

    const gemeente = props['kad:gemeente'];
    const sectie = props['kad:sectie'];
    const perceel = props['kad:perceelnr'];
    const perceeltvg = props['kad:perceelnrtvg'] || '';

    if(!gemeente || !sectie || !perceel){
      infoDiv.innerHTML = buildPopupTable({}, props);
      return;
    }

    let url = `https://oat.hisgis.nl/oat-ws/rest/percelen/${encodeURIComponent(gemeente)}/${encodeURIComponent(sectie)}/${encodeURIComponent(perceel)}`;
    if(perceeltvg) url += `/${encodeURIComponent(perceeltvg)}`;

    fetch(url).then(resp => {
      if(!resp.ok){
        infoDiv.innerHTML = `<p>Fout bij laden gegevens (status ${resp.status}): ${resp.statusText}</p>` + buildPopupTable({}, props);
        throw new Error(`HTTP error ${resp.status}`);
      }
      return resp.json();
    }).then(data => {
      const oatTags = (data.results && data.results.length > 0) ? data.results[0] : {};
      infoDiv.innerHTML = buildPopupTable(oatTags, props);
    }).catch(e => {
      infoDiv.innerHTML = `<p>Fout bij laden gegevens: ${e.message}</p>` + buildPopupTable({}, props);
      console.error('OAT API error:', e);
    });
  });

  console.log('OSM data laden...');
  fetch('https://osm.hisgis.nl/api/0.6/map?bbox=5.76,52.61,5.79,52.67',{
    headers: {'Accept': 'application/json'}
  })
  .then(resp => resp.json())
  .then(osmJson => {
    const geojson = osmtogeojson(osmJson);
    const format = new ol.format.GeoJSON();
    const features = format.readFeatures(geojson, {
      dataProjection:'EPSG:4326',
      featureProjection:'EPSG:3857'
    });
    vectorSource.clear();
    vectorSource.addFeatures(features);
  })
  .catch(e => {console.error('Fout bij laden OSM data:', e);});
})();
</script>
</body>
</html>
