<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<title>OpenLayers Kadaster met LayerSwitcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-layerswitcher/dist/ol-layerswitcher.css" />
<style>
  html, body, #map {
    margin: 0; padding: 0; width: 100%; height: 100%;
  }
  .ol-popup {
    position: absolute;
    background-color: white;
    padding: 5px 10px;
    border: 1px solid #ccc;
    bottom: 12px;
    left: -50px;
    min-width: 200px;
  }
  .ol-popup:after, .ol-popup:before {
    top: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
  }
  .ol-popup:after {
    border-top-color: white;
    border-width: 10px;
    left: 48px;
    margin-left: -10px;
  }
  .ol-popup:before {
    border-top-color: #ccc;
    border-width: 11px;
    left: 48px;
    margin-left: -11px;
  }
  .label {
    background-color: rgba(161, 0, 0, 0.7);
    color: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-weight: bold;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body>
<div id="map"></div>
<div id="popup" class="ol-popup" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ol-layerswitcher"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="osmtogeojson.js"></script>

<script>
  // Maak map en base layers
  const osmLayer = new ol.layer.Tile({
    source: new ol.source.OSM(),
    visible: true,
    title: 'OpenStreetMap',
    type: 'base'
  });

  const luchtfotoLayer = new ol.layer.Tile({
    source: new ol.source.TileWMS({
      url: 'https://service.pdok.nl/hwh/luchtfotorgb/wmts/v1_0?',
      params: {LAYERS:'Actueel_ortho25', FORMAT:'image/jpeg'},
      serverType: 'geoserver'
    }),
    visible: false,
    title: 'PDOK Luchtfoto',
    type: 'base'
  });

  const minuutplanLayer = new ol.layer.Tile({
    source: new ol.source.XYZ({
      url: 'https://tileserver.huc.knaw.nl/{z}/{x}/{y}'
    }),
    visible: false,
    title: 'Minuutplan 1832',
    type: 'base'
  });

  const vectorSource = new ol.source.Vector();
  const vectorLayer = new ol.layer.Vector({
    source: vectorSource,
    title: 'Percelen',
    style: feature => {
      const tags = feature.get('tags') || {};
      if(tags.building) {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(255,68,68,0.4)'}),
          stroke: new ol.style.Stroke({color: '#a10000', width: 2}),
          text: new ol.style.Text({
            font: 'bold 14px Calibri,sans-serif',
            text: map.getView().getZoom() >= 18 ? buildLabelText(feature) : '',
            fill: new ol.style.Fill({color: '#a10000'}),
            stroke: new ol.style.Stroke({color: 'white', width: 3}),
            overflow: true
          })
        });
      }
      if(tags.natural === 'water') {
        return new ol.style.Style({
          fill: new ol.style.Fill({color: 'rgba(118,169,255,0.35)'}),
          stroke: new ol.style.Stroke({color: '#1380ff', width: 2})
        });
      }
      return new ol.style.Style({
        fill: new ol.style.Fill({color: 'rgba(255,255,255,0.4)'}),
        stroke: new ol.style.Stroke({color: '#a10000', width: 2}),
        text: new ol.style.Text({
          font: 'bold 14px Calibri,sans-serif',
          text: map.getView().getZoom() >= 18 ? buildLabelText(feature) : '',
          fill: new ol.style.Fill({color: '#a10000'}),
          stroke: new ol.style.Stroke({color: 'white', width: 3}),
          overflow: true
        })
      });
    }
  });

  const map = new ol.Map({
    target: 'map',
    layers: [osmLayer, luchtfotoLayer, minuutplanLayer, vectorLayer],
    view: new ol.View({
      center: ol.proj.fromLonLat([5.775, 52.64]),
      zoom: 14,
      minZoom: 2,
      maxZoom: 22
    })
  });

  // Layer switcher toevoegen
  const layerSwitcher = new ol.control.LayerSwitcher();
  map.addControl(layerSwitcher);

  // Popup setup
  const popupContainer = document.getElementById('popup');
  const popupOverlay = new ol.Overlay({
    element: popupContainer,
    positioning: 'bottom-center',
    stopEvent: false,
    offset: [0, -10]
  });
  map.addOverlay(popupOverlay);

  // Bouw label tekst
  function buildLabelText(feature) {
    const tags = feature.get('tags') || {};
    let label = tags['kad:perceelnr'] || '';
    if (tags['kad:perceelnrtvg']) {
      label += '/' + tags['kad:perceelnrtvg'];
    }
    return label;
  }

  // Klik event met Turf.js hole detectie
  map.on('singleclick', function (evt) {
    popupOverlay.setPosition(undefined);
    popupContainer.style.display = 'none';

    const clickedFeatures = [];
    map.forEachFeatureAtPixel(evt.pixel, function (feature) {
      clickedFeatures.push(feature);
    });

    if (clickedFeatures.length === 0) return;

    for (const feature of clickedFeatures) {
      const geom = feature.getGeometry();
      const geoCoords = geom.clone().transform('EPSG:3857', 'EPSG:4326').getCoordinates();
      let turfGeom = null;
      if (geom.getType() === 'Polygon') {
        turfGeom = turf.polygon(geoCoords);
      } else if (geom.getType() === 'MultiPolygon') {
        turfGeom = turf.multiPolygon(geoCoords);
      }

      if (turfGeom) {
        const clickPoint = turf.point(ol.proj.toLonLat(evt.coordinate));
        let insideHole = false;
        for (let i = 1; i < turfGeom.geometry.coordinates.length; i++) {
          const hole = turf.polygon([turfGeom.geometry.coordinates[i]]);
          if (turf.booleanPointInPolygon(clickPoint, hole)) {
            insideHole = true;
            break;
          }
        }
        if (insideHole) continue;
      }

      const tags = feature.get('tags') || {};
      popupContainer.innerHTML = '<strong>Tags:</strong>' + tagsTable(tags);
      popupOverlay.setPosition(evt.coordinate);
      popupContainer.style.display = 'block';
      break;
    }
  });

  // Laad en converteer OSM API data
  fetch('https://osm.hisgis.nl/api/0.6/map?bbox=5.76,52.61,5.79,52.67', {
    headers: { 'Accept': 'application/json' }
  })
  .then(resp => resp.json())
  .then(osmJson => {
    const geojson = osmtogeojson(osmJson);
    const format = new ol.format.GeoJSON();
    const features = format.readFeatures(geojson, {
      dataProjection: 'EPSG:4326',
      featureProjection: 'EPSG:3857'
    });
    vectorSource.clear();
    vectorSource.addFeatures(features);
  })
  .catch(err => {
    console.error('Fout bij laden data:', err);
  });

  // Hulpfunctie voor popup tabel
  function tagsTable(tags) {
    let html = '<table><thead><tr><th>tag</th><th>waarde</th></tr></thead><tbody>';
    for(let key in tags) {
      html += `<tr><td>${key}</td><td>${tags[key]}</td></tr>`;
    }
    html += '</tbody></table>';
    return html;
  }
</script>
</body>
</html>
